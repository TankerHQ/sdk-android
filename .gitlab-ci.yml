include:
  - project: TankerHQ/gitlab-ci-files
    ref: 2021-07-07-1
    file: /common.yml

############
# Workflow #
############

workflow:
  rules:
    # web pipelines for releases only
    - if: $CI_PIPELINE_SOURCE == "web" && $SDK_ANDROID_RELEASE_VERSION !~ /\A\d+\.\d+\.\d+(-(alpha|beta)-\d+)?\z/
      when: never
    - if: $SDK_NATIVE_LATEST_CONAN_REFERENCE !~ /\Atanker\/(latest-stable@|(\d+\.\d+\.\d+(-(alpha|beta)\d+)?@(\w+\/\w+)?))\z/
      when: never
    # allow everything else
    - when: always

###########
# Default #
###########

default:
  before_script: &global_before_script
    - poetry run python -m pip install --upgrade pip
    - poetry install
    - export PATH=$(poetry env info -p)/bin:$PATH
  image: registry.gitlab.com/tankerhq/docker/sdk-android:latest

##########
# Stages #
##########

stages:
  - check
  - bridge-check
  - deploy

.check:
  stage: check

.bridge-check:
  stage: bridge-check

.deploy:
  stage: deploy

#############################
# Default settings override #
#############################

.before-script/download-artifacts:
  before_script:
    - *global_before_script
    - poetry run python run-ci.py download-artifacts --project-id=$UPSTREAM_PROJECT_ID --pipeline-id=$UPSTREAM_PIPELINE_ID --job-name=$UPSTREAM_JOB_NAME
    - poetry run python run-ci.py reset-branch $(cat branch_name.txt)
    - poetry run python -m pip install --upgrade pip
    - poetry install

###############
# check stage #
###############

.artifacts:
  artifacts:
    when: always
    paths:
      - artifacts
      - branch_name.txt

.rules/check/deployed-native:
  rules:
    - !reference [.rules/web/auto, rules]
    - !reference [.rules/mr/manual, rules]

check/deployed-native:
  extends:
    - .check
    - .tags/linux
    - .rules/check/deployed-native
    - .artifacts
  script:
    - sudo chgrp 1000 -f /dev/kvm
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --tanker-ref=$SDK_NATIVE_LATEST_CONAN_REFERENCE
    - echo $CI_COMMIT_REF_NAME > branch_name.txt

check/native-from-sources:
  extends:
    - .check
    - .tags/linux
    - .rules/native-from-sources
    - .artifacts
  script:
    - sudo chgrp 1000 -f /dev/kvm
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=same-as-branch
    - echo $CI_COMMIT_REF_NAME > branch_name.txt

check/downstream:
  extends:
    - .check
    - .tags/linux
    - .before-script/download-artifacts
    - .rules/check/downstream
    - .artifacts
  script:
    - sudo chgrp 1000 -f /dev/kvm
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=upstream

######################
# bridge-check stage #
######################

bridge/native-from-sources:
  extends:
    - .bridge-check
    - .rules/native-from-sources
    - .variables/bridge-common
  needs:
    - check/native-from-sources
  variables:
    UPSTREAM_JOB_NAME: check/native-from-sources
    UPSTREAM_JOB_TARGET: android
  trigger:
    project: TankerHQ/sdk-react-native
    strategy: depend

bridge/downstream:
  extends:
    - .bridge-check
    - .rules/check/downstream
    - .variables/bridge-common
  needs:
    - check/downstream
  variables:
    UPSTREAM_JOB_NAME: check/downstream
    UPSTREAM_JOB_TARGET: android
  trigger:
    project: TankerHQ/sdk-react-native
    strategy: depend

.rules/bridge/deployed-native:
  rules: !reference [.rules/check/deployed-native, rules]

bridge/deployed-native:
  extends:
    - .bridge-check
    - .rules/bridge/deployed-native
    - .variables/bridge-common
  needs:
    - check/deployed-native
  variables:
    UPSTREAM_JOB_NAME: check/deployed-native
    UPSTREAM_JOB_TARGET: android
  trigger:
    project: TankerHQ/sdk-react-native
    strategy: depend

################
# deploy stage #
################

deploy:
  extends:
    - .deploy
    - .tags/linux
    - .rules/deploy/android
  script:
    - sudo chgrp 1000 -f /dev/kvm
    - poetry run python run-ci.py reset-branch $UPSTREAM_BRANCH_NAME
    - poetry run python run-ci.py --isolate-conan-user-home deploy --version $SDK_ANDROID_RELEASE_VERSION --tanker-ref $SDK_NATIVE_LATEST_CONAN_REFERENCE
  release:
    description: sdk-android v$SDK_ANDROID_RELEASE_VERSION
    tag_name: v$SDK_ANDROID_RELEASE_VERSION
